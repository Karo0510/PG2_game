<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <canvas id="myCanvas" width="800" height="600" style="border:1px solid #d3d3d3;">
        Your browser does not support the HTML5 canvas tag.</canvas>
        <script>

            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");

            CirclesArray = [];
            CirclesBulletArray = [];

            isGameOver = false;

            class Rectangle
            {
                constructor(x, y, dx, x_size, y_size)
                {
                    this.x = x;
                    this.y = y;
                    this.dx = dx;
                    this.x_size = x_size;
                    this.y_size = y_size;
                }

                drawRectangle()
                { 
                    console.log(this.x+" "+this.y);
                    ctx.beginPath();
                    ctx.rect(this.x, this.y-this.y_size, this.x_size, this.y_size);
                    ctx.fillStyle = "black";
                    ctx.fill();
                    ctx.stroke();
                }
            }

            class Circles
            {
                constructor(x, y, r, dy)
                {
                    this.x = x;
                    this.y = y;
                    this.r = r;
                    this.dy = dy;
                }

                drawCircle()
                {
                    ctx.beginPath();
                    ctx.arc(this.x,this.y, this.r, 0, 2*Math.PI);
                    ctx.fillStyle = "black";
                    ctx.fill();
                    ctx.stroke();
                }

                moveCircle()
                {
                    this.drawCircle();
                    if (this.y + this.r < h - 50)
                    {
                        this.y += this.dy;
                    }
                    else
                    {
                        //this.dy = 0;
                        isGameOver = true;
                        location.reload();
                    }
                }
   
            }

            class CirclesBullet
            {
                constructor(x, y, r, dy)
                {
                    this.x = x;
                    this.y = y;
                    this.r = r;
                    this.dy = dy;
                }

                drawCircleBullet()
                {
                    ctx.beginPath();
                    ctx.arc(this.x,this.y, this.r, 0, 2*Math.PI);
                    ctx.fillStyle = "red";
                    ctx.fill();
                    ctx.stroke();
                }

                moveCircleBullet()
                {
                    this.drawCircleBullet();
                    if (this.y + this.r > 0)
                    {
                        this.y -= this.dy;
                    }
                    else
                    {
                        this.dy = 0;
                    }
                }

            }


            const w = 800;
            const h = 600;

            rightPressed = false;
            leftPressed = false;
            space = false;

            var r = new Rectangle(0, 600, 10, 50, 50);

            function addCircle()
            {
                x = Math.floor(Math.random()*(w-25));
                var c = new Circles(x, 20, 20, 5);
                CirclesArray.push(c);
            }

            setInterval(addCircle, 1000);

            function addBullet()
            {
                x = r.x + r.x_size/2;
                y = h - r.y_size + 5;
                var b = new CirclesBullet(x, y, 5, 5);
                CirclesBulletArray.push(b)
            }

            function updateCircles()
            {
                for (var i = 0; i<CirclesArray.length; i++)
                {
                    CirclesArray[i].moveCircle();
                }
            }

            function updateBullet()
            {
                for (var i = 0; i<CirclesBulletArray.length; i++)
                {
                    CirclesBulletArray[i].moveCircleBullet();

                    if (CirclesBulletArray[i].y <= 0)
                    {
                        CirclesBulletArray.splice(i, 1);
                    }
                    Collision();
                }
            }

            function clear()
            {
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, w, h);
                ctx.fill();   
            }
   

            function move()
            {
                if (rightPressed)
                {
                    r.x += r.dx;

                    if ((r.x + r.x_size  > w))
                    {
                        r.x = w-r.x_size;
                    }
                }else if (leftPressed)
                {
                    r.x -= r.dx;

                    if (r.x <= 0)
                    {
                        r.x = 0;
                    }
                }else if (space)
                {
                    addBullet();
                }
                
            }

            function getDistance(x1, x2, y1, y2)
            {
                var dist_x = x1 - x2;
                var dist_y = y1 - y2;

                return Math.sqrt(Math.pow(dist_x, 2) + Math.pow(dist_y, 2));
            }

            function Collision()
            {
                for (var i = 0; i < CirclesArray.length; i++)
                {
                    for (var j = 0; j<CirclesBulletArray.length; j++)
                    {
                        x1 = CirclesArray[i].x;
                        y1 = CirclesArray[i].y;
                        x2 = CirclesBulletArray[j].x;
                        y2 = CirclesBulletArray[j].y;

                        r1 = CirclesArray[i].r;
                        r2 = CirclesBulletArray[j].r

                        var wynik = getDistance(x1, x2, y1, y2);

                        if (wynik <= r1+r2)
                        {
                            CirclesArray.splice(i, 1)
                            CirclesBulletArray.splice(j, 1);
                        }
                    }
                }
            }

            function pressKey(e)
            {
                if (e.key == "ArrowRight")
                {
                    rightPressed = true;
                }
                
                if (e.key == "ArrowLeft")
                {
                    leftPressed = true;
                }
                if (e.key == " ")
                {
                    space = true;
                }
                console.log(rightPressed);
            }

            function releaseKey(e)
            {
                if(e.key == "ArrowRight") 
                {
                    rightPressed = false;
                }
                else if(e.key == "ArrowLeft") 
                {
                    leftPressed = false;
                }
                else if (e.key == " ")
                {
                    space = false;
                }
            }

            document.addEventListener("keydown", pressKey, false);
            document.addEventListener("keyup", releaseKey, false);

            function animate()
            {
                if (!isGameOver)
                {
                    move();
                    clear();
                    r.drawRectangle();  
                    updateCircles();
                    updateBullet();
                }
                else
                {
                    alert('Game Over');
                }
                

            }

            setInterval(function() {animate()}, 10);
       
        </script> 
    
</body>
</html>